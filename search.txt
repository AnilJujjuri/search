import socket
from pyModbusTCP.server import ModbusServer
import random
import time

hostname = socket.gethostname()
server_ip_address = socket.gethostbyname(hostname)
server_port = 502

print(f"[+]Info : IP Address for Modbus Server : {server_ip_address}")

server = ModbusServer(server_ip_address, server_port, no_block=True)
server.start()

print(f"[+]info : Server is Online on IP : {server_ip_address} and PORT : {server_port}")

# Define register names and initialize values
register_names = {
    0: "Energy Consumption",
    1: "Voltage",
    2: "Current",
    3: "Power"
}

register_values = {register: 0 for register in register_names}

try:
    while True:
        # Generate random values for registers
        for register in register_values:
            register_values[register] = random.randint(0, 100) if register != 2 else random.randint(50, 200)

        # Update holding registers
        for register, value in register_values.items():
            server.data_bank.set_holding_registers(register, [value])

        # Print register names and values
        for register, value in register_values.items():
            print(f"{register_names.get(register)}: {value}")

        time.sleep(2)  # You can add other code here if needed

except KeyboardInterrupt:
    server.stop()
